# 06 - ç»„ä»¶ç”Ÿå‘½å‘¨æœŸåŸºç¡€

## ç”Ÿå‘½å‘¨æœŸæ¦‚è¿°

React ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æŒ‡ç»„ä»¶ä»åˆ›å»ºåˆ°é”€æ¯çš„æ•´ä¸ªè¿‡ç¨‹ã€‚åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨ useEffect Hook æ¥å¤„ç†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚

### ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ
1. **æŒ‚è½½é˜¶æ®µï¼ˆMountingï¼‰**ï¼šç»„ä»¶è¢«åˆ›å»ºå¹¶æ’å…¥ DOM
2. **æ›´æ–°é˜¶æ®µï¼ˆUpdatingï¼‰**ï¼šç»„ä»¶çš„ props æˆ– state å‘ç”Ÿå˜åŒ–
3. **å¸è½½é˜¶æ®µï¼ˆUnmountingï¼‰**ï¼šç»„ä»¶ä» DOM ä¸­ç§»é™¤

## useEffect è¯¦è§£

### åŸºæœ¬ç”¨æ³•
```jsx
import React, { useState, useEffect } from 'react';

function LifecycleExample() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState('');
  
  // 1. ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œï¼ˆç›¸å½“äº componentDidMountï¼‰
  useEffect(() => {
    console.log('ç»„ä»¶å·²æŒ‚è½½');
    document.title = 'ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹';
    
    // æ¸…ç†å‡½æ•°ï¼ˆç›¸å½“äº componentWillUnmountï¼‰
    return () => {
      console.log('ç»„ä»¶å³å°†å¸è½½');
      document.title = 'React App';
    };
  }, []); // ç©ºä¾èµ–æ•°ç»„è¡¨ç¤ºåªåœ¨æŒ‚è½½æ—¶æ‰§è¡Œ
  
  // 2. æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½æ‰§è¡Œï¼ˆç›¸å½“äº componentDidUpdateï¼‰
  useEffect(() => {
    console.log('ç»„ä»¶é‡æ–°æ¸²æŸ“äº†');
  }); // æ²¡æœ‰ä¾èµ–æ•°ç»„
  
  // 3. ä¾èµ–ç‰¹å®šå€¼çš„å˜åŒ–
  useEffect(() => {
    console.log('count å‘ç”Ÿäº†å˜åŒ–:', count);
    localStorage.setItem('count', count.toString());
  }, [count]); // åªæœ‰ count å˜åŒ–æ—¶æ‰æ‰§è¡Œ
  
  // 4. å¤šä¸ªä¾èµ–é¡¹
  useEffect(() => {
    console.log('count æˆ– name å‘ç”Ÿäº†å˜åŒ–');
    if (name) {
      document.title = `${name} - è®¡æ•°: ${count}`;
    }
  }, [count, name]);
  
  return (
    <div>
      <h2>ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹</h2>
      <p>è®¡æ•°ï¼š{count}</p>
      <button onClick={() => setCount(count + 1)}>å¢åŠ </button>
      
      <div>
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="è¾“å…¥ä½ çš„åå­—"
        />
      </div>
    </div>
  );
}
```

## å®è·µæ¡ˆä¾‹ï¼šæ•°æ®è·å–ä¸æ¸…ç†

### å®šæ—¶å™¨ç®¡ç†
```jsx
function TimerComponent() {
  const [seconds, setSeconds] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [timerId, setTimerId] = useState(null);
  
  // å¯åŠ¨/åœæ­¢å®šæ—¶å™¨çš„å‰¯ä½œç”¨
  useEffect(() => {
    if (isRunning) {
      const id = setInterval(() => {
        setSeconds(prev => prev + 1);
      }, 1000);
      setTimerId(id);
      
      // æ¸…ç†å‡½æ•°
      return () => {
        clearInterval(id);
      };
    } else {
      if (timerId) {
        clearInterval(timerId);
        setTimerId(null);
      }
    }
  }, [isRunning]); // ä¾èµ– isRunning çŠ¶æ€
  
  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
  useEffect(() => {
    return () => {
      if (timerId) {
        clearInterval(timerId);
      }
    };
  }, [timerId]);
  
  const handleStart = () => setIsRunning(true);
  const handleStop = () => setIsRunning(false);
  const handleReset = () => {
    setIsRunning(false);
    setSeconds(0);
  };
  
  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  const formatTime = (totalSeconds) => {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const secs = totalSeconds % 60;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };
  
  return (
    <div style={{ padding: '20px', textAlign: 'center' }}>
      <h2>è®¡æ—¶å™¨</h2>
      <div style={{ fontSize: '2em', margin: '20px 0' }}>
        {formatTime(seconds)}
      </div>
      <div>
        <button onClick={handleStart} disabled={isRunning}>
          å¼€å§‹
        </button>
        <button onClick={handleStop} disabled={!isRunning} style={{ margin: '0 10px' }}>
          åœæ­¢
        </button>
        <button onClick={handleReset}>
          é‡ç½®
        </button>
      </div>
      <p>çŠ¶æ€ï¼š{isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}</p>
    </div>
  );
}
```

### çª—å£å¤§å°ç›‘å¬
```jsx
function WindowSizeTracker() {
  const [windowSize, setWindowSize] = useState({
    width: window.innerWidth,
    height: window.innerHeight
  });
  
  useEffect(() => {
    console.log('è®¾ç½®çª—å£å¤§å°ç›‘å¬å™¨');
    
    const handleResize = () => {
      setWindowSize({
        width: window.innerWidth,
        height: window.innerHeight
      });
    };
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    window.addEventListener('resize', handleResize);
    
    // æ¸…ç†å‡½æ•°ï¼šç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    return () => {
      console.log('ç§»é™¤çª—å£å¤§å°ç›‘å¬å™¨');
      window.removeEventListener('resize', handleResize);
    };
  }, []); // ç©ºä¾èµ–æ•°ç»„ï¼Œåªåœ¨æŒ‚è½½å’Œå¸è½½æ—¶æ‰§è¡Œ
  
  return (
    <div style={{ padding: '20px' }}>
      <h2>çª—å£å¤§å°è¿½è¸ªå™¨</h2>
      <p>å½“å‰çª—å£å¤§å°ï¼š</p>
      <ul>
        <li>å®½åº¦ï¼š{windowSize.width}px</li>
        <li>é«˜åº¦ï¼š{windowSize.height}px</li>
        <li>æ¯”ä¾‹ï¼š{(windowSize.width / windowSize.height).toFixed(2)}</li>
      </ul>
      <p style={{ color: '#666', fontSize: '14px' }}>
        è°ƒæ•´æµè§ˆå™¨çª—å£å¤§å°è¯•è¯•çœ‹
      </p>
    </div>
  );
}
```

## æ•°æ®è·å–ç”Ÿå‘½å‘¨æœŸ

### API æ•°æ®è·å–
```jsx
function DataFetcher({ userId }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  useEffect(() => {
    // é˜²æ­¢å†…å­˜æ³„æ¼çš„æ ‡å¿—
    let isCancelled = false;
    
    const fetchUser = async () => {
      console.log('å¼€å§‹è·å–ç”¨æˆ·æ•°æ®ï¼Œç”¨æˆ·ID:', userId);
      setLoading(true);
      setError(null);
      
      try {
        // æ¨¡æ‹Ÿ API è¯·æ±‚
        const response = await fetch(`/api/users/${userId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const userData = await response.json();
        
        // æ£€æŸ¥è¯·æ±‚æ˜¯å¦è¢«å–æ¶ˆ
        if (!isCancelled) {
          setUser(userData);
        }
      } catch (err) {
        if (!isCancelled) {
          setError(err.message);
        }
      } finally {
        if (!isCancelled) {
          setLoading(false);
        }
      }
    };
    
    // å¦‚æœæœ‰ userId æ‰å‘èµ·è¯·æ±‚
    if (userId) {
      fetchUser();
    } else {
      setUser(null);
      setLoading(false);
    }
    
    // æ¸…ç†å‡½æ•°ï¼šæ ‡è®°è¯·æ±‚ä¸ºå·²å–æ¶ˆ
    return () => {
      console.log('å–æ¶ˆç”¨æˆ·æ•°æ®è¯·æ±‚');
      isCancelled = true;
    };
  }, [userId]); // ä¾èµ– userIdï¼Œå½“ userId å˜åŒ–æ—¶é‡æ–°è·å–æ•°æ®
  
  if (loading) {
    return (
      <div style={{ padding: '20px' }}>
        <p>åŠ è½½ä¸­...</p>
      </div>
    );
  }
  
  if (error) {
    return (
      <div style={{ padding: '20px', color: 'red' }}>
        <p>é”™è¯¯ï¼š{error}</p>
      </div>
    );
  }
  
  if (!user) {
    return (
      <div style={{ padding: '20px' }}>
        <p>è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ·</p>
      </div>
    );
  }
  
  return (
    <div style={{ padding: '20px', border: '1px solid #ddd', borderRadius: '5px' }}>
      <h3>ç”¨æˆ·ä¿¡æ¯</h3>
      <p><strong>å§“åï¼š</strong>{user.name}</p>
      <p><strong>é‚®ç®±ï¼š</strong>{user.email}</p>
      <p><strong>ç”µè¯ï¼š</strong>{user.phone}</p>
    </div>
  );
}

// ä½¿ç”¨ DataFetcher çš„çˆ¶ç»„ä»¶
function UserManager() {
  const [selectedUserId, setSelectedUserId] = useState(null);
  
  const userIds = [1, 2, 3, 4, 5];
  
  return (
    <div style={{ padding: '20px' }}>
      <h2>ç”¨æˆ·ç®¡ç†</h2>
      
      <div style={{ marginBottom: '20px' }}>
        <label>é€‰æ‹©ç”¨æˆ·ï¼š</label>
        <select 
          value={selectedUserId || ''} 
          onChange={(e) => setSelectedUserId(e.target.value ? Number(e.target.value) : null)}
        >
          <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
          {userIds.map(id => (
            <option key={id} value={id}>ç”¨æˆ· {id}</option>
          ))}
        </select>
      </div>
      
      <DataFetcher userId={selectedUserId} />
    </div>
  );
}
```

## æ¡ä»¶ç”Ÿå‘½å‘¨æœŸ

### åŠ¨æ€ç»„ä»¶æŒ‚è½½å’Œå¸è½½
```jsx
function ConditionalLifecycle() {
  const [showTimer, setShowTimer] = useState(false);
  const [showTracker, setShowTracker] = useState(false);
  const [mountCount, setMountCount] = useState(0);
  
  // è·Ÿè¸ªç»„ä»¶æŒ‚è½½æ¬¡æ•°
  useEffect(() => {
    setMountCount(prev => prev + 1);
    console.log('ConditionalLifecycle ç»„ä»¶æŒ‚è½½æ¬¡æ•°:', mountCount + 1);
  }, []);
  
  return (
    <div style={{ padding: '20px' }}>
      <h2>æ¡ä»¶ç”Ÿå‘½å‘¨æœŸæ¼”ç¤º</h2>
      <p>ç»„ä»¶æŒ‚è½½æ¬¡æ•°ï¼š{mountCount}</p>
      
      <div style={{ marginBottom: '20px' }}>
        <button 
          onClick={() => setShowTimer(!showTimer)}
          style={{ marginRight: '10px' }}
        >
          {showTimer ? 'éšè—' : 'æ˜¾ç¤º'} è®¡æ—¶å™¨
        </button>
        
        <button onClick={() => setShowTracker(!showTracker)}>
          {showTracker ? 'éšè—' : 'æ˜¾ç¤º'} çª—å£è¿½è¸ªå™¨
        </button>
      </div>
      
      {/* æ¡ä»¶æ¸²æŸ“ç»„ä»¶ */}
      {showTimer && (
        <div style={{ border: '1px solid blue', margin: '10px 0' }}>
          <TimerComponent />
        </div>
      )}
      
      {showTracker && (
        <div style={{ border: '1px solid green', margin: '10px 0' }}>
          <WindowSizeTracker />
        </div>
      )}
      
      {!showTimer && !showTracker && (
        <p style={{ color: '#666', fontStyle: 'italic' }}>
          ç‚¹å‡»æŒ‰é’®æ˜¾ç¤ºç»„ä»¶ï¼Œè§‚å¯Ÿæ§åˆ¶å°ä¸­çš„ç”Ÿå‘½å‘¨æœŸæ—¥å¿—
        </p>
      )}
    </div>
  );
}
```

## è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸ Hook

### ç»„ä»¶æŒ‚è½½çŠ¶æ€æ£€æµ‹
```jsx
import { useRef, useEffect } from 'react';

// æ£€æµ‹ç»„ä»¶æ˜¯å¦å·²æŒ‚è½½çš„ Hook
function useIsMounted() {
  const isMounted = useRef(false);
  
  useEffect(() => {
    isMounted.current = true;
    return () => {
      isMounted.current = false;
    };
  }, []);
  
  return isMounted;
}

// å‰ä¸€ä¸ªå€¼çš„ Hook
function usePrevious(value) {
  const ref = useRef();
  
  useEffect(() => {
    ref.current = value;
  });
  
  return ref.current;
}

// ç”Ÿå‘½å‘¨æœŸæ—¥å¿— Hook
function useLifecycleLogger(componentName) {
  useEffect(() => {
    console.log(`[${componentName}] ç»„ä»¶æŒ‚è½½`);
    
    return () => {
      console.log(`[${componentName}] ç»„ä»¶å¸è½½`);
    };
  }, [componentName]);
  
  useEffect(() => {
    console.log(`[${componentName}] ç»„ä»¶æ›´æ–°`);
  });
}

// ä½¿ç”¨è‡ªå®šä¹‰ Hook çš„ç»„ä»¶
function CustomHookExample() {
  const [count, setCount] = useState(0);
  const [name, setName] = useState('');
  
  const isMounted = useIsMounted();
  const prevCount = usePrevious(count);
  
  useLifecycleLogger('CustomHookExample');
  
  // å»¶è¿Ÿæ›´æ–°çŠ¶æ€ï¼ŒéªŒè¯ç»„ä»¶æŒ‚è½½çŠ¶æ€
  const delayedUpdate = () => {
    setTimeout(() => {
      if (isMounted.current) {
        setCount(prev => prev + 10);
      } else {
        console.log('ç»„ä»¶å·²å¸è½½ï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°');
      }
    }, 2000);
  };
  
  return (
    <div style={{ padding: '20px' }}>
      <h2>è‡ªå®šä¹‰ Hook ç¤ºä¾‹</h2>
      
      <div>
        <p>å½“å‰è®¡æ•°ï¼š{count}</p>
        <p>å‰ä¸€ä¸ªè®¡æ•°ï¼š{prevCount}</p>
        <p>ç»„ä»¶æ˜¯å¦å·²æŒ‚è½½ï¼š{isMounted.current ? 'æ˜¯' : 'å¦'}</p>
      </div>
      
      <div>
        <button onClick={() => setCount(count + 1)}>
          ç«‹å³å¢åŠ 
        </button>
        <button onClick={delayedUpdate} style={{ marginLeft: '10px' }}>
          å»¶è¿Ÿå¢åŠ  (2ç§’å)
        </button>
      </div>
      
      <div style={{ marginTop: '20px' }}>
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="è¾“å…¥åå­—è§¦å‘æ›´æ–°"
        />
      </div>
    </div>
  );
}
```

## å®è·µæ¡ˆä¾‹ï¼šèŠå¤©åº”ç”¨

### å®æ—¶æ¶ˆæ¯ç»„ä»¶
```jsx
function ChatComponent() {
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  const [isConnected, setIsConnected] = useState(false);
  const [unreadCount, setUnreadCount] = useState(0);
  const messagesEndRef = useRef(null);
  
  // æ¨¡æ‹Ÿ WebSocket è¿æ¥
  useEffect(() => {
    console.log('å»ºç«‹èŠå¤©è¿æ¥');
    setIsConnected(true);
    
    // æ¨¡æ‹Ÿæ¥æ”¶æ¶ˆæ¯
    const interval = setInterval(() => {
      const randomMessages = [
        'ä½ å¥½ï¼',
        'æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ',
        'æœ‰æ—¶é—´èŠèŠå—ï¼Ÿ',
        'ä»Šå¤©å¤©æ°”ä¸é”™',
        'å‘¨æœ«æœ‰ä»€ä¹ˆè®¡åˆ’ï¼Ÿ'
      ];
      
      const randomMessage = randomMessages[Math.floor(Math.random() * randomMessages.length)];
      
      setMessages(prev => [...prev, {
        id: Date.now(),
        text: randomMessage,
        sender: 'friend',
        timestamp: new Date()
      }]);
      
      setUnreadCount(prev => prev + 1);
    }, 5000);
    
    // æ¸…ç†å‡½æ•°ï¼šæ–­å¼€è¿æ¥
    return () => {
      console.log('æ–­å¼€èŠå¤©è¿æ¥');
      setIsConnected(false);
      clearInterval(interval);
    };
  }, []);
  
  // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
  useEffect(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [messages]);
  
  // é¡µé¢æ ‡é¢˜æ˜¾ç¤ºæœªè¯»æ¶ˆæ¯æ•°
  useEffect(() => {
    if (unreadCount > 0) {
      document.title = `(${unreadCount}) æ–°æ¶ˆæ¯ - èŠå¤©åº”ç”¨`;
    } else {
      document.title = 'èŠå¤©åº”ç”¨';
    }
    
    // ç»„ä»¶å¸è½½æ—¶æ¢å¤åŸæ ‡é¢˜
    return () => {
      document.title = 'React App';
    };
  }, [unreadCount]);
  
  // ç›‘å¬é”®ç›˜äº‹ä»¶
  useEffect(() => {
    const handleKeyPress = (e) => {
      if (e.key === 'Enter' && e.ctrlKey) {
        sendMessage();
      }
    };
    
    window.addEventListener('keydown', handleKeyPress);
    
    return () => {
      window.removeEventListener('keydown', handleKeyPress);
    };
  }, [newMessage]);
  
  const sendMessage = () => {
    if (newMessage.trim()) {
      setMessages(prev => [...prev, {
        id: Date.now(),
        text: newMessage,
        sender: 'me',
        timestamp: new Date()
      }]);
      setNewMessage('');
      setUnreadCount(0); // å‘é€æ¶ˆæ¯æ—¶æ¸…é›¶æœªè¯»æ•°
    }
  };
  
  const formatTime = (date) => {
    return date.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  };
  
  return (
    <div style={{ 
      padding: '20px', 
      maxWidth: '600px', 
      margin: '0 auto',
      border: '1px solid #ddd',
      borderRadius: '10px'
    }}>
      <div style={{ 
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center',
        marginBottom: '20px',
        paddingBottom: '10px',
        borderBottom: '1px solid #eee'
      }}>
        <h2>èŠå¤©å®¤</h2>
        <div>
          <span style={{ 
            color: isConnected ? 'green' : 'red',
            marginRight: '10px'
          }}>
            {isConnected ? 'ğŸŸ¢ å·²è¿æ¥' : 'ğŸ”´ æœªè¿æ¥'}
          </span>
          {unreadCount > 0 && (
            <span style={{
              backgroundColor: 'red',
              color: 'white',
              borderRadius: '50%',
              padding: '2px 6px',
              fontSize: '12px'
            }}>
              {unreadCount}
            </span>
          )}
        </div>
      </div>
      
      <div style={{ 
        height: '300px', 
        overflowY: 'auto', 
        border: '1px solid #ddd',
        padding: '10px',
        marginBottom: '10px',
        backgroundColor: '#fafafa'
      }}>
        {messages.map(message => (
          <div key={message.id} style={{
            marginBottom: '10px',
            textAlign: message.sender === 'me' ? 'right' : 'left'
          }}>
            <div style={{
              display: 'inline-block',
              padding: '8px 12px',
              borderRadius: '10px',
              backgroundColor: message.sender === 'me' ? '#007bff' : '#e9ecef',
              color: message.sender === 'me' ? 'white' : 'black',
              maxWidth: '70%'
            }}>
              <div>{message.text}</div>
              <div style={{ 
                fontSize: '10px', 
                opacity: 0.7,
                marginTop: '2px'
              }}>
                {formatTime(message.timestamp)}
              </div>
            </div>
          </div>
        ))}
        <div ref={messagesEndRef} />
      </div>
      
      <div style={{ display: 'flex', gap: '10px' }}>
        <input
          type="text"
          value={newMessage}
          onChange={(e) => setNewMessage(e.target.value)}
          placeholder="è¾“å…¥æ¶ˆæ¯... (Ctrl+Enter å‘é€)"
          style={{ flex: 1, padding: '8px' }}
          onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
        />
        <button 
          onClick={sendMessage}
          disabled={!newMessage.trim() || !isConnected}
        >
          å‘é€
        </button>
      </div>
    </div>
  );
}
```

## ç»ƒä¹ ä»»åŠ¡

1. åˆ›å»ºä¸€ä¸ªéŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶ï¼Œå¤„ç†æ’­æ”¾çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸ
2. å®ç°ä¸€ä¸ªå›¾ç‰‡è½®æ’­ç»„ä»¶ï¼Œè‡ªåŠ¨åˆ‡æ¢å’Œæ‰‹åŠ¨æ§åˆ¶
3. åˆ¶ä½œä¸€ä¸ªå€’è®¡æ—¶ç»„ä»¶ï¼Œæ”¯æŒæš‚åœå’Œé‡ç½®åŠŸèƒ½

## ä¸‹ä¸€æ­¥

æŒæ¡ç»„ä»¶ç”Ÿå‘½å‘¨æœŸåï¼Œæ¥ä¸‹æ¥å°†å­¦ä¹ æ›´é«˜çº§çš„ä¸»é¢˜ï¼šè·¯ç”±ç®¡ç†ã€‚