# Vue 3 计算属性与侦听器

## 1. 计算属性基础

计算属性是基于其响应式依赖进行缓存的。只有在相关响应式依赖发生改变时它们才会重新求值。

### 基本用法
```vue
<template>
    <div class="computed-demo">
        <h2>计算属性演示</h2>
        
        <!-- 基本计算属性 -->
        <div class="section">
            <h3>个人信息</h3>
            <div class="form-group">
                <label>姓:</label>
                <input v-model="lastName" placeholder="请输入姓">
            </div>
            <div class="form-group">
                <label>名:</label>
                <input v-model="firstName" placeholder="请输入名">
            </div>
            <div class="result">
                <p>全名: {{ fullName }}</p>
                <p>全名长度: {{ fullNameLength }}</p>
                <p>反转全名: {{ reversedFullName }}</p>
            </div>
        </div>
        
        <!-- 购物车计算 -->
        <div class="section">
            <h3>购物车</h3>
            <div class="cart-items">
                <div v-for="item in cartItems" :key="item.id" class="cart-item">
                    <span>{{ item.name }}</span>
                    <span>¥{{ item.price }}</span>
                    <div class="quantity-controls">
                        <button @click="updateQuantity(item.id, item.quantity - 1)">-</button>
                        <span>{{ item.quantity }}</span>
                        <button @click="updateQuantity(item.id, item.quantity + 1)">+</button>
                    </div>
                    <span class="subtotal">¥{{ item.price * item.quantity }}</span>
                    <button @click="removeItem(item.id)" class="remove-btn">删除</button>
                </div>
            </div>
            
            <div class="cart-summary">
                <div class="summary-row">
                    <span>商品总数:</span>
                    <span>{{ totalItems }} 件</span>
                </div>
                <div class="summary-row">
                    <span>商品小计:</span>
                    <span>¥{{ subtotal.toFixed(2) }}</span>
                </div>
                <div class="summary-row">
                    <span>运费:</span>
                    <span>¥{{ shippingFee.toFixed(2) }}</span>
                </div>
                <div class="summary-row">
                    <span>优惠券:</span>
                    <span class="discount">-¥{{ discountAmount.toFixed(2) }}</span>
                </div>
                <div class="summary-row total">
                    <span>总计:</span>
                    <span>¥{{ finalTotal.toFixed(2) }}</span>
                </div>
            </div>
            
            <button @click="addRandomItem" class="add-btn">添加随机商品</button>
        </div>
        
        <!-- 搜索过滤 -->
        <div class="section">
            <h3>商品搜索</h3>
            <div class="search-controls">
                <input v-model="searchQuery" placeholder="搜索商品..." class="search-input">
                <select v-model="sortBy" class="sort-select">
                    <option value="name">按名称排序</option>
                    <option value="price">按价格排序</option>
                    <option value="rating">按评分排序</option>
                </select>
                <select v-model="filterCategory" class="filter-select">
                    <option value="">所有分类</option>
                    <option value="electronics">电子产品</option>
                    <option value="clothing">服装</option>
                    <option value="books">图书</option>
                </select>
            </div>
            
            <div class="products-grid">
                <div v-for="product in filteredAndSortedProducts" :key="product.id" class="product-card">
                    <h4>{{ product.name }}</h4>
                    <p class="price">¥{{ product.price }}</p>
                    <p class="category">{{ product.category }}</p>
                    <div class="rating">
                        <span v-for="star in 5" :key="star" 
                              :class="{ filled: star <= product.rating }">★</span>
                        <span class="rating-text">({{ product.rating }})</span>
                    </div>
                    <button @click="addToCart(product)">加入购物车</button>
                </div>
            </div>
            
            <div class="search-stats">
                <p>找到 {{ filteredAndSortedProducts.length }} 个商品</p>
                <p v-if="searchQuery">搜索: "{{ searchQuery }}"</p>
            </div>
        </div>
    </div>
</template>

<script>
export default {
    name: 'ComputedDemo',
    
    data() {
        return {
            firstName: '',
            lastName: '',
            
            cartItems: [
                { id: 1, name: '笔记本电脑', price: 5999, quantity: 1 },
                { id: 2, name: '无线鼠标', price: 199, quantity: 2 },
                { id: 3, name: '机械键盘', price: 699, quantity: 1 }
            ],
            
            products: [
                { id: 1, name: '智能手机', price: 3999, category: 'electronics', rating: 4.5 },
                { id: 2, name: '蓝牙耳机', price: 299, category: 'electronics', rating: 4.2 },
                { id: 3, name: 'T恤', price: 89, category: 'clothing', rating: 4.0 },
                { id: 4, name: '牛仔裤', price: 299, category: 'clothing', rating: 4.3 },
                { id: 5, name: 'JavaScript权威指南', price: 129, category: 'books', rating: 4.8 },
                { id: 6, name: 'Vue.js实战', price: 89, category: 'books', rating: 4.6 }
            ],
            
            searchQuery: '',
            sortBy: 'name',
            filterCategory: '',
            discountRate: 0.1, // 10% 优惠
            freeShippingThreshold: 500 // 满500免运费
        }
    },
    
    computed: {
        // 基本计算属性
        fullName() {
            return `${this.lastName}${this.firstName}`.trim()
        },
        
        fullNameLength() {
            return this.fullName.length
        },
        
        reversedFullName() {
            return this.fullName.split('').reverse().join('')
        },
        
        // 购物车相关计算属性
        totalItems() {
            return this.cartItems.reduce((total, item) => total + item.quantity, 0)
        },
        
        subtotal() {
            return this.cartItems.reduce((total, item) => total + (item.price * item.quantity), 0)
        },
        
        shippingFee() {
            return this.subtotal >= this.freeShippingThreshold ? 0 : 50
        },
        
        discountAmount() {
            return this.subtotal * this.discountRate
        },
        
        finalTotal() {
            return this.subtotal + this.shippingFee - this.discountAmount
        },
        
        // 搜索和过滤
        filteredProducts() {
            let filtered = this.products
            
            // 按分类过滤
            if (this.filterCategory) {
                filtered = filtered.filter(product => product.category === this.filterCategory)
            }
            
            // 按搜索词过滤
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase()
                filtered = filtered.filter(product => 
                    product.name.toLowerCase().includes(query)
                )
            }
            
            return filtered
        },
        
        filteredAndSortedProducts() {
            let sorted = [...this.filteredProducts]
            
            switch (this.sortBy) {
                case 'name':
                    sorted.sort((a, b) => a.name.localeCompare(b.name))
                    break
                case 'price':
                    sorted.sort((a, b) => a.price - b.price)
                    break
                case 'rating':
                    sorted.sort((a, b) => b.rating - a.rating)
                    break
            }
            
            return sorted
        },
        
        // 复杂计算属性 - 统计信息
        categoryStats() {
            const stats = {}
            
            this.products.forEach(product => {
                if (!stats[product.category]) {
                    stats[product.category] = {
                        count: 0,
                        totalPrice: 0,
                        avgRating: 0,
                        maxPrice: 0,
                        minPrice: Infinity
                    }
                }
                
                const category = stats[product.category]
                category.count++
                category.totalPrice += product.price
                category.maxPrice = Math.max(category.maxPrice, product.price)
                category.minPrice = Math.min(category.minPrice, product.price)
            })
            
            // 计算平均价格和评分
            Object.values(stats).forEach(category => {
                category.avgPrice = category.totalPrice / category.count
            })
            
            return stats
        }
    },
    
    methods: {
        updateQuantity(itemId, newQuantity) {
            if (newQuantity <= 0) {
                this.removeItem(itemId)
                return
            }
            
            const item = this.cartItems.find(item => item.id === itemId)
            if (item) {
                item.quantity = newQuantity
            }
        },
        
        removeItem(itemId) {
            this.cartItems = this.cartItems.filter(item => item.id !== itemId)
        },
        
        addToCart(product) {
            const existingItem = this.cartItems.find(item => item.id === product.id)
            
            if (existingItem) {
                existingItem.quantity++
            } else {
                this.cartItems.push({
                    ...product,
                    quantity: 1
                })
            }
        },
        
        addRandomItem() {
            const availableProducts = this.products.filter(
                product => !this.cartItems.some(item => item.id === product.id)
            )
            
            if (availableProducts.length > 0) {
                const randomProduct = availableProducts[Math.floor(Math.random() * availableProducts.length)]
                this.addToCart(randomProduct)
            }
        }
    }
}
</script>

<style scoped>
.computed-demo {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.section {
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f9f9f9;
}

.section h3 {
    margin-top: 0;
    color: #333;
}

.form-group {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.form-group label {
    width: 50px;
    margin-right: 10px;
    color: #666;
}

.form-group input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    flex: 1;
}

.result {
    background: white;
    padding: 15px;
    border-radius: 4px;
    margin-top: 15px;
}

.result p {
    margin: 5px 0;
    color: #333;
}

.cart-item {
    display: grid;
    grid-template-columns: 2fr 1fr 150px 1fr auto;
    gap: 15px;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 4px;
    margin-bottom: 10px;
}

.quantity-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}

.quantity-controls button {
    width: 30px;
    height: 30px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.subtotal {
    font-weight: bold;
    color: #e74c3c;
}

.remove-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
}

.cart-summary {
    background: white;
    padding: 20px;
    border-radius: 4px;
    margin: 20px 0;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 5px 0;
}

.summary-row.total {
    border-top: 2px solid #ddd;
    padding-top: 15px;
    margin-top: 15px;
    font-weight: bold;
    font-size: 18px;
    color: #333;
}

.discount {
    color: #28a745;
}

.add-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.search-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
}

.search-input,
.sort-select,
.filter-select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.search-input {
    flex: 1;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.product-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #ddd;
    text-align: center;
}

.product-card h4 {
    margin: 0 0 10px 0;
    color: #333;
}

.price {
    font-size: 18px;
    font-weight: bold;
    color: #e74c3c;
    margin: 10px 0;
}

.category {
    color: #666;
    font-size: 14px;
    margin: 5px 0;
}

.rating {
    margin: 10px 0;
}

.rating span {
    color: #ddd;
    font-size: 16px;
}

.rating span.filled {
    color: #ffd700;
}

.rating-text {
    margin-left: 5px;
    color: #666;
    font-size: 14px;
}

.product-card button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
}

.search-stats {
    background: white;
    padding: 15px;
    border-radius: 4px;
    text-align: center;
    color: #666;
}

.search-stats p {
    margin: 5px 0;
}
</style>
```

## 2. 计算属性的 getter 和 setter

```vue
<template>
    <div class="getter-setter-demo">
        <h2>计算属性 Getter/Setter 演示</h2>
        
        <!-- 温度转换器 -->
        <div class="section">
            <h3>温度转换器</h3>
            <div class="temperature-converter">
                <div class="input-group">
                    <label>摄氏度 (°C):</label>
                    <input v-model.number="celsius" type="number" step="0.1">
                </div>
                <div class="input-group">
                    <label>华氏度 (°F):</label>
                    <input v-model.number="fahrenheit" type="number" step="0.1">
                </div>
                <div class="input-group">
                    <label>开尔文 (K):</label>
                    <input v-model.number="kelvin" type="number" step="0.1">
                </div>
                <div class="temperature-display">
                    <p>{{ temperatureDescription }}</p>
                </div>
            </div>
        </div>
        
        <!-- 颜色选择器 -->
        <div class="section">
            <h3>颜色选择器</h3>
            <div class="color-picker">
                <div class="color-inputs">
                    <div class="input-group">
                        <label>RGB:</label>
                        <input v-model="rgbColor" placeholder="rgb(255, 0, 0)">
                    </div>
                    <div class="input-group">
                        <label>HEX:</label>
                        <input v-model="hexColor" placeholder="#ff0000">
                    </div>
                    <div class="input-group">
                        <label>HSL:</label>
                        <input v-model="hslColor" placeholder="hsl(0, 100%, 50%)">
                    </div>
                </div>
                
                <div class="color-display" :style="{ backgroundColor: hexColor }">
                    <p>当前颜色</p>
                </div>
                
                <div class="color-sliders">
                    <div class="slider-group">
                        <label>红色 (R): {{ red }}</label>
                        <input v-model.number="red" type="range" min="0" max="255">
                    </div>
                    <div class="slider-group">
                        <label>绿色 (G): {{ green }}</label>
                        <input v-model.number="green" type="range" min="0" max="255">
                    </div>
                    <div class="slider-group">
                        <label>蓝色 (B): {{ blue }}</label>
                        <input v-model.number="blue" type="range" min="0" max="255">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 全名编辑器 -->
        <div class="section">
            <h3>全名编辑器</h3>
            <div class="name-editor">
                <div class="input-group">
                    <label>全名:</label>
                    <input v-model="fullName" placeholder="张 三">
                </div>
                <div class="input-group">
                    <label>姓:</label>
                    <input v-model="lastName" placeholder="张">
                </div>
                <div class="input-group">
                    <label>名:</label>
                    <input v-model="firstName" placeholder="三">
                </div>
                <div class="name-preview">
                    <p>姓名: {{ lastName }} {{ firstName }}</p>
                    <p>全名: {{ fullName }}</p>
                    <p>姓名长度: {{ fullName.replace(/\s+/g, '').length }} 个字符</p>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
export default {
    name: 'GetterSetterDemo',
    
    data() {
        return {
            celsiusValue: 20,
            firstNameValue: '',
            lastNameValue: '',
            redValue: 255,
            greenValue: 0,
            blueValue: 0
        }
    },
    
    computed: {
        // 温度转换
        celsius: {
            get() {
                return this.celsiusValue
            },
            set(value) {
                this.celsiusValue = parseFloat(value) || 0
            }
        },
        
        fahrenheit: {
            get() {
                return (this.celsius * 9/5) + 32
            },
            set(value) {
                this.celsius = (parseFloat(value) - 32) * 5/9
            }
        },
        
        kelvin: {
            get() {
                return this.celsius + 273.15
            },
            set(value) {
                this.celsius = parseFloat(value) - 273.15
            }
        },
        
        temperatureDescription() {
            if (this.celsius < 0) return '冰点以下'
            if (this.celsius < 10) return '很冷'
            if (this.celsius < 20) return '冷'
            if (this.celsius < 25) return '舒适'
            if (this.celsius < 30) return '温暖'
            if (this.celsius < 35) return '热'
            return '很热'
        },
        
        // 全名处理
        firstName: {
            get() {
                return this.firstNameValue
            },
            set(value) {
                this.firstNameValue = value
            }
        },
        
        lastName: {
            get() {
                return this.lastNameValue
            },
            set(value) {
                this.lastNameValue = value
            }
        },
        
        fullName: {
            get() {
                return `${this.lastName} ${this.firstName}`.trim()
            },
            set(value) {
                const names = value.trim().split(/\s+/)
                if (names.length >= 2) {
                    this.lastName = names[0]
                    this.firstName = names.slice(1).join(' ')
                } else if (names.length === 1) {
                    this.lastName = names[0]
                    this.firstName = ''
                }
            }
        },
        
        // 颜色处理
        red: {
            get() {
                return this.redValue
            },
            set(value) {
                this.redValue = Math.max(0, Math.min(255, parseInt(value) || 0))
            }
        },
        
        green: {
            get() {
                return this.greenValue
            },
            set(value) {
                this.greenValue = Math.max(0, Math.min(255, parseInt(value) || 0))
            }
        },
        
        blue: {
            get() {
                return this.blueValue
            },
            set(value) {
                this.blueValue = Math.max(0, Math.min(255, parseInt(value) || 0))
            }
        },
        
        rgbColor: {
            get() {
                return `rgb(${this.red}, ${this.green}, ${this.blue})`
            },
            set(value) {
                const match = value.match(/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/)
                if (match) {
                    this.red = parseInt(match[1])
                    this.green = parseInt(match[2])
                    this.blue = parseInt(match[3])
                }
            }
        },
        
        hexColor: {
            get() {
                const toHex = (n) => n.toString(16).padStart(2, '0')
                return `#${toHex(this.red)}${toHex(this.green)}${toHex(this.blue)}`
            },
            set(value) {
                const hex = value.replace('#', '')
                if (hex.length === 6) {
                    this.red = parseInt(hex.substr(0, 2), 16)
                    this.green = parseInt(hex.substr(2, 2), 16)
                    this.blue = parseInt(hex.substr(4, 2), 16)
                }
            }
        },
        
        hslColor: {
            get() {
                const r = this.red / 255
                const g = this.green / 255
                const b = this.blue / 255
                
                const max = Math.max(r, g, b)
                const min = Math.min(r, g, b)
                let h, s, l = (max + min) / 2
                
                if (max === min) {
                    h = s = 0
                } else {
                    const d = max - min
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min)
                    
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break
                        case g: h = (b - r) / d + 2; break
                        case b: h = (r - g) / d + 4; break
                    }
                    h /= 6
                }
                
                return `hsl(${Math.round(h * 360)}, ${Math.round(s * 100)}%, ${Math.round(l * 100)}%)`
            },
            set(value) {
                const match = value.match(/hsl\(\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%\s*\)/)
                if (match) {
                    const h = parseInt(match[1]) / 360
                    const s = parseInt(match[2]) / 100
                    const l = parseInt(match[3]) / 100
                    
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1
                        if (t > 1) t -= 1
                        if (t < 1/6) return p + (q - p) * 6 * t
                        if (t < 1/2) return q
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6
                        return p
                    }
                    
                    let r, g, b
                    
                    if (s === 0) {
                        r = g = b = l
                    } else {
                        const q = l < 0.5 ? l * (1 + s) : l + s - l * s
                        const p = 2 * l - q
                        r = hue2rgb(p, q, h + 1/3)
                        g = hue2rgb(p, q, h)
                        b = hue2rgb(p, q, h - 1/3)
                    }
                    
                    this.red = Math.round(r * 255)
                    this.green = Math.round(g * 255)
                    this.blue = Math.round(b * 255)
                }
            }
        }
    }
}
</script>

<style scoped>
.getter-setter-demo {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.section {
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f9f9f9;
}

.section h3 {
    margin-top: 0;
    color: #333;
}

.input-group {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.input-group label {
    min-width: 120px;
    margin-right: 10px;
    color: #666;
}

.input-group input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    flex: 1;
}

.temperature-display,
.name-preview {
    background: white;
    padding: 15px;
    border-radius: 4px;
    margin-top: 15px;
}

.temperature-display p,
.name-preview p {
    margin: 5px 0;
    color: #333;
}

.color-picker {
    display: grid;
    grid-template-columns: 1fr 200px;
    gap: 20px;
}

.color-display {
    height: 200px;
    border-radius: 8px;
    border: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
    font-weight: bold;
}

.color-sliders {
    grid-column: 1 / -1;
}

.slider-group {
    margin-bottom: 15px;
}

.slider-group label {
    display: block;
    margin-bottom: 5px;
    color: #666;
}

.slider-group input[type="range"] {
    width: 100%;
    margin: 0;
}
</style>
```

## 3. 侦听器 (Watch)

侦听器用于观察和响应 Vue 实例上的数据变动。

### 基本侦听器
```vue
<template>
    <div class="watch-demo">
        <h2>侦听器演示</h2>
        
        <!-- 基本侦听 -->
        <div class="section">
            <h3>基本侦听器</h3>
            <div class="input-group">
                <label>用户名:</label>
                <input v-model="username" placeholder="输入用户名">
            </div>
            <div class="validation-message">
                <p v-if="usernameValidation.message" 
                   :class="usernameValidation.isValid ? 'success' : 'error'">
                    {{ usernameValidation.message }}
                </p>
            </div>
            
            <div class="input-group">
                <label>密码:</label>
                <input v-model="password" type="password" placeholder="输入密码">
            </div>
            <div class="password-strength">
                <div class="strength-bar">
                    <div class="strength-fill" 
                         :style="{ width: passwordStrength.percentage + '%' }"
                         :class="passwordStrength.level"></div>
                </div>
                <p>密码强度: {{ passwordStrength.text }}</p>
            </div>
        </div>
        
        <!-- 深度侦听 -->
        <div class="section">
            <h3>深度侦听 - 用户资料</h3>
            <div class="profile-form">
                <div class="input-group">
                    <label>姓名:</label>
                    <input v-model="userProfile.name" placeholder="姓名">
                </div>
                <div class="input-group">
                    <label>邮箱:</label>
                    <input v-model="userProfile.email" placeholder="邮箱">
                </div>
                <div class="input-group">
                    <label>年龄:</label>
                    <input v-model.number="userProfile.age" type="number" placeholder="年龄">
                </div>
                <div class="input-group">
                    <label>城市:</label>
                    <select v-model="userProfile.address.city">
                        <option value="">选择城市</option>
                        <option value="beijing">北京</option>
                        <option value="shanghai">上海</option>
                        <option value="guangzhou">广州</option>
                        <option value="shenzhen">深圳</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>详细地址:</label>
                    <input v-model="userProfile.address.street" placeholder="详细地址">
                </div>
                
                <div class="profile-status">
                    <p>资料完整度: {{ profileCompleteness }}%</p>
                    <p>最后修改时间: {{ lastModified }}</p>
                    <p v-if="hasUnsavedChanges" class="warning">有未保存的更改</p>
                </div>
                
                <button @click="saveProfile" :disabled="!hasUnsavedChanges">
                    保存资料
                </button>
            </div>
        </div>
        
        <!-- 异步侦听 -->
        <div class="section">
            <h3>异步侦听 - 搜索建议</h3>
            <div class="search-box">
                <input v-model="searchTerm" placeholder="搜索用户..." class="search-input">
                <div v-if="isSearching" class="loading">搜索中...</div>
                <ul v-if="searchResults.length > 0" class="search-results">
                    <li v-for="result in searchResults" :key="result.id" 
                        @click="selectUser(result)" class="search-result-item">
                        <div class="user-info">
                            <strong>{{ result.name }}</strong>
                            <span>{{ result.email }}</span>
                        </div>
                    </li>
                </ul>
                <div v-if="searchTerm && !isSearching && searchResults.length === 0" class="no-results">
                    未找到相关用户
                </div>
            </div>
        </div>
        
        <!-- 侦听器日志 -->
        <div class="section">
            <h3>侦听器日志</h3>
            <div class="controls">
                <button @click="clearLogs">清空日志</button>
                <label>
                    <input type="checkbox" v-model="enableLogging">
                    启用日志记录
                </label>
            </div>
            <div class="log-container">
                <div v-for="log in watchLogs" :key="log.id" class="log-entry">
                    <span class="timestamp">{{ formatTime(log.timestamp) }}</span>
                    <span class="property">{{ log.property }}</span>
                    <span class="change">{{ log.oldValue }} → {{ log.newValue }}</span>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
export default {
    name: 'WatchDemo',
    
    data() {
        return {
            username: '',
            password: '',
            usernameValidation: {
                isValid: false,
                message: ''
            },
            passwordStrength: {
                level: 'weak',
                text: '弱',
                percentage: 0
            },
            
            userProfile: {
                name: '',
                email: '',
                age: null,
                address: {
                    city: '',
                    street: ''
                }
            },
            savedProfile: null,
            lastModified: '',
            
            searchTerm: '',
            searchResults: [],
            isSearching: false,
            searchTimeout: null,
            
            watchLogs: [],
            enableLogging: true,
            logId: 1
        }
    },
    
    computed: {
        profileCompleteness() {
            const fields = [
                this.userProfile.name,
                this.userProfile.email,
                this.userProfile.age,
                this.userProfile.address.city,
                this.userProfile.address.street
            ]
            
            const filledFields = fields.filter(field => field && field.toString().trim()).length
            return Math.round((filledFields / fields.length) * 100)
        },
        
        hasUnsavedChanges() {
            return JSON.stringify(this.userProfile) !== JSON.stringify(this.savedProfile)
        }
    },
    
    watch: {
        // 基本侦听器
        username: {
            handler(newVal, oldVal) {
                this.logChange('username', oldVal, newVal)
                this.validateUsername(newVal)
            },
            immediate: true
        },
        
        password: {
            handler(newVal, oldVal) {
                this.logChange('password', oldVal ? '***' : '', newVal ? '***' : '')
                this.checkPasswordStrength(newVal)
            },
            immediate: true
        },
        
        // 深度侦听
        userProfile: {
            handler(newVal, oldVal) {
                this.lastModified = new Date().toLocaleString()
                this.logChange('userProfile', 'profile changed', 'profile updated')
            },
            deep: true
        },
        
        // 侦听特定嵌套属性
        'userProfile.address.city'(newVal, oldVal) {
            this.logChange('userProfile.address.city', oldVal, newVal)
            if (newVal) {
                console.log(`用户选择了城市: ${newVal}`)
            }
        },
        
        // 异步侦听器
        searchTerm: {
            handler(newVal, oldVal) {
                this.logChange('searchTerm', oldVal, newVal)
                
                // 清除之前的定时器
                if (this.searchTimeout) {
                    clearTimeout(this.searchTimeout)
                }
                
                if (!newVal.trim()) {
                    this.searchResults = []
                    this.isSearching = false
                    return
                }
                
                // 防抖处理
                this.isSearching = true
                this.searchTimeout = setTimeout(() => {
                    this.performSearch(newVal)
                }, 500)
            }
        }
    },
    
    methods: {
        validateUsername(username) {
            if (!username) {
                this.usernameValidation = {
                    isValid: false,
                    message: ''
                }
                return
            }
            
            if (username.length < 3) {
                this.usernameValidation = {
                    isValid: false,
                    message: '用户名至少需要3个字符'
                }
                return
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                this.usernameValidation = {
                    isValid: false,
                    message: '用户名只能包含字母、数字和下划线'
                }
                return
            }
            
            // 模拟异步验证
            setTimeout(() => {
                if (username === 'admin' || username === 'test') {
                    this.usernameValidation = {
                        isValid: false,
                        message: '该用户名已被占用'
                    }
                } else {
                    this.usernameValidation = {
                        isValid: true,
                        message: '用户名可用'
                    }
                }
            }, 300)
        },
        
        checkPasswordStrength(password) {
            if (!password) {
                this.passwordStrength = {
                    level: 'weak',
                    text: '弱',
                    percentage: 0
                }
                return
            }
            
            let score = 0
            
            // 长度检查
            if (password.length >= 8) score += 25
            if (password.length >= 12) score += 15
            
            // 字符类型检查
            if (/[a-z]/.test(password)) score += 15
            if (/[A-Z]/.test(password)) score += 15
            if (/\d/.test(password)) score += 15
            if (/[^a-zA-Z\d]/.test(password)) score += 15
            
            let level, text
            
            if (score < 30) {
                level = 'weak'
                text = '弱'
            } else if (score < 60) {
                level = 'medium'
                text = '中等'
            } else {
                level = 'strong'
                text = '强'
            }
            
            this.passwordStrength = {
                level,
                text,
                percentage: Math.min(score, 100)
            }
        },
        
        async performSearch(term) {
            try {
                // 模拟 API 调用
                await new Promise(resolve => setTimeout(resolve, 800))
                
                const mockUsers = [
                    { id: 1, name: '张三', email: 'zhangsan@example.com' },
                    { id: 2, name: '李四', email: 'lisi@example.com' },
                    { id: 3, name: '王五', email: 'wangwu@example.com' },
                    { id: 4, name: '赵六', email: 'zhaoliu@example.com' },
                    { id: 5, name: '钱七', email: 'qianqi@example.com' }
                ]
                
                this.searchResults = mockUsers.filter(user => 
                    user.name.includes(term) || user.email.includes(term)
                )
            } catch (error) {
                console.error('搜索失败:', error)
                this.searchResults = []
            } finally {
                this.isSearching = false
            }
        },
        
        selectUser(user) {
            this.searchTerm = user.name
            this.searchResults = []
            console.log('选择用户:', user)
        },
        
        saveProfile() {
            this.savedProfile = JSON.parse(JSON.stringify(this.userProfile))
            console.log('资料已保存:', this.savedProfile)
        },
        
        logChange(property, oldValue, newValue) {
            if (!this.enableLogging) return
            
            this.watchLogs.unshift({
                id: this.logId++,
                property,
                oldValue: oldValue || '(空)',
                newValue: newValue || '(空)',
                timestamp: Date.now()
            })
            
            // 只保留最近50条日志
            if (this.watchLogs.length > 50) {
                this.watchLogs = this.watchLogs.slice(0, 50)
            }
        },
        
        clearLogs() {
            this.watchLogs = []
        },
        
        formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString()
        }
    },
    
    mounted() {
        // 初始化保存的资料
        this.savedProfile = JSON.parse(JSON.stringify(this.userProfile))
    }
}
</script>

<style scoped>
.watch-demo {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.section {
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f9f9f9;
}

.section h3 {
    margin-top: 0;
    color: #333;
}

.input-group {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.input-group label {
    min-width: 100px;
    margin-right: 10px;
    color: #666;
}

.input-group input,
.input-group select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    flex: 1;
}

.validation-message {
    margin-left: 110px;
    margin-bottom: 15px;
}

.validation-message .success {
    color: #28a745;
}

.validation-message .error {
    color: #dc3545;
}

.password-strength {
    margin-left: 110px;
    margin-bottom: 15px;
}

.strength-bar {
    width: 200px;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 5px;
}

.strength-fill {
    height: 100%;
    transition: all 0.3s ease;
}

.strength-fill.weak {
    background: #dc3545;
}

.strength-fill.medium {
    background: #ffc107;
}

.strength-fill.strong {
    background: #28a745;
}

.profile-status {
    background: white;
    padding: 15px;
    border-radius: 4px;
    margin: 20px 0;
}

.profile-status p {
    margin: 5px 0;
    color: #333;
}

.profile-status .warning {
    color: #e67e22;
    font-weight: bold;
}

.search-box {
    position: relative;
}

.search-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
}

.loading {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
    font-size: 14px;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
    list-style: none;
    padding: 0;
    margin: 0;
}

.search-result-item {
    padding: 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.search-result-item:hover {
    background: #f8f9fa;
}

.search-result-item:last-child {
    border-bottom: none;
}

.user-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.user-info span {
    color: #666;
    font-size: 14px;
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #666;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
}

.controls {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-bottom: 20px;
}

.controls button {
    padding: 8px 16px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.controls label {
    display: flex;
    align-items: center;
    gap: 5px;
}

.log-container {
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.log-entry {
    display: flex;
    gap: 15px;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
    font-family: monospace;
    font-size: 14px;
}

.log-entry:last-child {
    border-bottom: none;
}

.timestamp {
    color: #666;
    min-width: 80px;
}

.property {
    color: #007bff;
    min-width: 120px;
}

.change {
    color: #333;
}
</style>
```

## 4. 学习要点

### 计算属性特点
- **缓存机制**：只有依赖发生变化才重新计算
- **响应式依赖**：自动追踪依赖的响应式数据
- **getter/setter**：支持双向绑定
- **性能优化**：比方法调用更高效

### 侦听器使用场景
- **异步操作**：API调用、数据验证
- **复杂逻辑**：需要在数据变化时执行的业务逻辑
- **深度监听**：监听对象内部属性变化
- **副作用处理**：日志记录、数据同步

### 最佳实践
- **选择合适的工具**：计算属性用于派生数据，侦听器用于执行操作
- **避免滥用**：不要在侦听器中修改被监听的数据
- **性能考虑**：合理使用深度监听和立即执行
- **清理副作用**：在组件销毁时清理定时器和事件监听

## 5. 练习建议

1. 创建一个货币转换器，支持多种货币间的转换
2. 实现一个实时表单验证系统
3. 创建一个数据统计面板，实时计算各种指标
4. 实现一个搜索和过滤功能，支持多条件筛选

下一节将学习 Vue 3 的生命周期钩子和错误处理。